<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>地铁站 V9 | 最终稳定版</title>
    <style>
        /* 基础样式：防止黑屏，默认深蓝背景 */
        body { margin: 0; overflow: hidden; background-color: #112; font-family: sans-serif; touch-action: none; user-select: none; -webkit-user-select: none; }
        #canvas-container { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 0; }

        /* 启动遮罩 */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #fff; transition: opacity 0.5s;
        }
        #start-btn {
            padding: 20px 60px; font-size: 1.5rem; background: #0f0; color: #000;
            border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 20px #0f0; margin-top: 20px;
        }

        /* 准星 */
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 8px; height: 8px;
            background: rgba(255, 255, 255, 0.8); border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 50;
            transition: all 0.2s; border: 2px solid rgba(0,0,0,0.5);
        }
        /* 准星激活状态 */
        .active-crosshair { background: #f00 !important; width: 16px !important; height: 16px !important; border-color: #fff !important; }

        /* 提示信息 */
        #msg {
            position: absolute; top: 30%; width: 100%; text-align: center;
            color: #ff0; text-shadow: 0 0 5px #000; font-size: 1.5rem;
            pointer-events: none; z-index: 50; opacity: 0; transition: opacity 0.3s;
        }

        /* --- 移动端专用 UI (默认隐藏) --- */
        .mobile-ui { display: none; position: absolute; z-index: 60; }
        
        /* 摇杆区域 */
        .joystick-area {
            width: 140px; height: 140px; bottom: 40px;
            background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
        }
        #stick-l { left: 30px; }
        #stick-r { right: 30px; }
        
        /* 摇杆头 */
        .knob {
            position: absolute; top: 50%; left: 50%; width: 50px; height: 50px;
            background: rgba(255, 255, 255, 0.6); border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none;
        }

        /* 互动按钮 (移动端专用) */
        #action-btn {
            bottom: 180px; right: 40px; width: 80px; height: 80px;
            background: rgba(0, 255, 255, 0.3); border: 2px solid #0ff; border-radius: 50%;
            display: none; justify-content: center; align-items: center; color: #fff; font-weight: bold;
        }
        #action-btn:active { background: rgba(0, 255, 255, 0.6); }

        #pc-hint { position: absolute; bottom: 20px; left: 20px; color: #888; pointer-events: none; z-index: 40; }
    </style>
</head>
<body>

    <div id="overlay">
        <h1 style="color: #4af; text-shadow: 0 0 20px #4af;">STATION V9</h1>
        <p>稳定版 | Stable Build</p>
        <button id="start-btn">启动 / START</button>
    </div>

    <div id="canvas-container"></div>
    <div id="crosshair"></div>
    <div id="msg"></div>
    <div id="pc-hint">WASD移动 | 鼠标看 | E键交互 | Shift跑</div>

    <!-- 移动端控件 -->
    <div id="stick-l" class="mobile-ui joystick-area"><div class="knob" id="knob-l"></div></div>
    <div id="stick-r" class="mobile-ui joystick-area"><div class="knob" id="knob-r"></div></div>
    <div id="action-btn" class="mobile-ui">交互</div>

    <!-- 引入稳定的 ESM 模块 -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://esm.sh/three@0.160.0",
                "three/addons/": "https://esm.sh/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- 全局配置 ---
        const CFG = {
            speed: 10,
            runSpeed: 20,
            gravity: 30,
            playerHeight: 1.6
        };

        // 变量
        let camera, scene, renderer, controls;
        let isMobile = false;
        let lastTime = performance.now();
        
        // 运动状态
        const input = { x: 0, y: 0, run: false };
        const velocity = new THREE.Vector3();
        const touchLook = { x: 0, y: 0 }; // 移动端视角偏移量

        // 场景对象
        const colliders = []; // 空气墙
        let trainGroup, trainActive = false, trainTimer = 0;
        let interactableObj = null; // 当前瞄准的对象

        // 音频
        let audioCtx;

        init();
        animate();

        function init() {
            // 1. 检测设备
            isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile) {
                document.querySelectorAll('.mobile-ui').forEach(el => el.style.display = 'flex');
                document.getElementById('pc-hint').style.display = 'none';
            }

            // 2. 渲染器
            const container = document.getElementById('canvas-container');
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            // 3. 场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111118); // 深蓝夜色
            scene.fog = new THREE.FogExp2(0x111118, 0.02);

            // 4. 相机
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 500);
            camera.position.set(5, 2, 0); // 站在站台中间
            camera.rotation.order = 'YXZ'; // 关键：防止万向节死锁

            // 5. 灯光 (确保够亮)
            const amb = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(amb);
            const dir = new THREE.DirectionalLight(0xaaddff, 0.8);
            dir.position.set(20, 50, 20);
            dir.castShadow = true;
            scene.add(dir);

            // 6. 控制器
            if (!isMobile) {
                controls = new PointerLockControls(camera, document.body);
            }

            // 7. 启动逻辑
            const btn = document.getElementById('start-btn');
            const overlay = document.getElementById('overlay');
            btn.addEventListener('click', async () => {
                overlay.style.opacity = 0;
                setTimeout(() => overlay.style.display = 'none', 500);
                
                await initAudio(); // 启动音频
                
                if (!isMobile) controls.lock();
                
                // 启动列车循环
                triggerTrain();
                setInterval(triggerTrain, 15000);
            });

            if (!isMobile) {
                controls.addEventListener('unlock', () => {
                    overlay.style.display = 'flex';
                    overlay.style.opacity = 1;
                    btn.innerText = "继续 (RESUME)";
                });
            }

            // 8. 构建世界
            buildWorld();
            setupInputs();

            window.addEventListener('resize', onResize);
        }

        // --- 场景构建 (纯几何体，无纹理，加载快) ---
        function buildWorld() {
            const matFloor = new THREE.MeshStandardMaterial({ color: 0x555555, roughness: 0.8 });
            const matWall = new THREE.MeshStandardMaterial({ color: 0x888899, roughness: 0.5 });
            const matTrack = new THREE.MeshStandardMaterial({ color: 0x111111 });

            // 1. 站台 (x: 0~20)
            const floor = new THREE.Mesh(new THREE.BoxGeometry(20, 1, 300), matFloor);
            floor.position.set(10, -0.5, 0);
            floor.receiveShadow = true;
            scene.add(floor);

            // 2. 轨道 (x: -20~0)
            const track = new THREE.Mesh(new THREE.BoxGeometry(20, 1, 300), matTrack);
            track.position.set(-10, -3.5, 0);
            scene.add(track);

            // 3. 后墙
            const wall = new THREE.Mesh(new THREE.BoxGeometry(2, 20, 300), matWall);
            wall.position.set(21, 10, 0);
            scene.add(wall);

            // 4. 柱子
            const colGeo = new THREE.BoxGeometry(1.5, 12, 1.5);
            for(let z=-80; z<=80; z+=20) {
                const c = new THREE.Mesh(colGeo, matWall);
                c.position.set(5, 6, z);
                c.castShadow = true;
                scene.add(c);
                // 添加柱子碰撞
                const box = new THREE.Box3().setFromObject(c);
                colliders.push(box);
                
                // 灯
                const l = new THREE.PointLight(0xccddff, 0.8, 15);
                l.position.set(5, 8, z);
                scene.add(l);
            }

            // 5. 售货机 (可交互)
            const vm = new THREE.Group();
            const vmBody = new THREE.Mesh(new THREE.BoxGeometry(2,4,2), new THREE.MeshStandardMaterial({color:0x222}));
            vmBody.position.y = 2;
            vm.add(vmBody);
            const vmScreen = new THREE.Mesh(new THREE.PlaneGeometry(1.5,1), new THREE.MeshBasicMaterial({color:0x00ff00}));
            vmScreen.position.set(0,2.5,-1.01); vmScreen.rotation.y = Math.PI;
            vm.add(vmScreen);
            
            vm.position.set(18, 0, 10);
            vm.name = "vending_machine"; // 标记名字用于交互
            scene.add(vm);

            // 售货机碰撞
            const vmBox = new THREE.Box3().setFromObject(vm);
            colliders.push(vmBox);

            // 6. 边界空气墙 (死死挡住)
            // 后方
            colliders.push(new THREE.Box3(new THREE.Vector3(20, -10, -200), new THREE.Vector3(22, 50, 200)));
            // 前方 (轨道深处)
            colliders.push(new THREE.Box3(new THREE.Vector3(-50, -10, -200), new THREE.Vector3(-15, 50, 200)));
            // 左边界
            colliders.push(new THREE.Box3(new THREE.Vector3(-50, -10, -150), new THREE.Vector3(50, 50, -152)));
            // 右边界
            colliders.push(new THREE.Box3(new THREE.Vector3(-50, -10, 150), new THREE.Vector3(50, 50, 152)));

            // 7. 列车
            trainGroup = new THREE.Group();
            const tBody = new THREE.Mesh(new THREE.BoxGeometry(4.2, 4.5, 80), new THREE.MeshStandardMaterial({color:0xcccccc}));
            tBody.position.y = 2.25;
            trainGroup.add(tBody);
            const tLight = new THREE.SpotLight(0xffffff, 50, 100);
            tLight.position.set(0,2,41); tLight.target.position.set(0,0,100);
            trainGroup.add(tLight); trainGroup.add(tLight.target);
            
            trainGroup.position.set(-6, -3, -400);
            scene.add(trainGroup);
        }

        // --- 输入系统 ---
        function setupInputs() {
            // PC
            document.addEventListener('keydown', e => {
                if(e.code==='KeyW') input.y = 1;
                if(e.code==='KeyS') input.y = -1;
                if(e.code==='KeyA') input.x = -1;
                if(e.code==='KeyD') input.x = 1;
                if(e.code==='ShiftLeft') input.run = true;
                if(e.code==='KeyE') tryInteract();
            });
            document.addEventListener('keyup', e => {
                if(e.code==='KeyW'||e.code==='KeyS') input.y = 0;
                if(e.code==='KeyA'||e.code==='KeyD') input.x = 0;
                if(e.code==='ShiftLeft') input.run = false;
            });
            document.addEventListener('mousedown', tryInteract); // 鼠标左键也可交互

            // Mobile Joysticks
            if(isMobile) {
                // 左摇杆：移动
                setupJoystick('stick-l', 'knob-l', (x, y) => {
                    input.x = x; input.y = -y; // 摇杆向上是y负，对应前进
                });
                // 右摇杆：视角
                setupJoystick('stick-r', 'knob-r', (x, y) => {
                    touchLook.x = x * 2.0; // 灵敏度
                    touchLook.y = y * 2.0;
                });
                // 交互按钮
                const actBtn = document.getElementById('action-btn');
                actBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    tryInteract();
                    actBtn.style.background = "rgba(0, 255, 255, 0.6)";
                });
                actBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    actBtn.style.background = "rgba(0, 255, 255, 0.3)";
                });
            }
        }

        function setupJoystick(areaId, knobId, callback) {
            const area = document.getElementById(areaId);
            const knob = document.getElementById(knobId);
            const rect = area.getBoundingClientRect();
            const center = { x: rect.
